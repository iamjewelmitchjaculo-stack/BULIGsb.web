<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign In - Bulig Sta. Barbara</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/theme.css" />
</head>

<body>



  <section class="py-5">
    <div class="rounded-card">

      <h3 class="text-center fw-bold">Sign in</h3>
      <p class="text-center mb-4">Welcome back — sign in to continue</p>

      <form id="loginForm" method="post" action="#">

        <label class="fw-semibold">Email</label>
        <input name="email" class="form-control mb-3" required placeholder="Enter your email address" type="email" />

        <label class="fw-semibold">Password</label>
        <input name="password" class="form-control mb-4" type="password" required placeholder="Enter your password" />

        <button class="btn btn-orange w-100" type="submit">Sign In</button>

        <div class="text-center mt-3 small">
          <a href="signup.html">Don't have an account? Sign up</a>
        </div>

      </form>
    </div>
  </section>

  <script type="module">
    import { loginUser, sendPasswordReset, getUserRole } from './firebase-auth.js';
    import { auth } from './firebase-config.js';
    import { confirmModal } from './modal.js';

    const form = document.getElementById('loginForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = e.target;
      const email = f.email.value;
      const password = f.password.value;
      try {
        const cred = await loginUser(email, password);
        const role = await getUserRole(cred.user.uid);
        if (role === 'admin') {
          window.location.href = 'admin.html';
        } else {
          window.location.href = 'categories.html';
        }
      } catch (err) {
        // Handle common auth errors with helpful actions
        if (err && err.code === 'auth/user-not-found') {
          const create = await confirmModal('No account found for this email. Create one now?', 'Create Account', 'Cancel');
          if (create) {
            window.location.href = `signup.html?email=${encodeURIComponent(email)}`;
          }
        } else if (err && err.code === 'auth/wrong-password') {
          const send = await confirmModal('Password is incorrect. Send a password reset email?', 'Send Reset', 'Cancel');
          if (send) {
            try {
              await sendPasswordReset(email);
              alert('Password reset email sent — check your inbox.');
            } catch (resetErr) {
              alert(resetErr.message || 'Failed to send password reset email');
            }
          }
        } else {
          alert(err.message || 'Sign in failed');
        }
      }
    });

    // If already signed-in, redirect based on role
    try {
      const user = auth && auth.currentUser;
      if (user) {
        const role = await getUserRole(user.uid);
        window.location.href = role === 'admin' ? 'admin.html' : 'categories.html';
      }
    } catch(e) {}

    // Prefill email from query string (but never prefill password)
    const params = new URLSearchParams(window.location.search);
    const qEmail = params.get('email');
    if (qEmail) {
      const emailInput = document.querySelector('input[name=email]');
      if (emailInput) emailInput.value = decodeURIComponent(qEmail);
    }
    // Remove password from URL if present to avoid leaking it
    if (params.has('password')) {
      params.delete('password');
      const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      history.replaceState({}, document.title, newUrl);
    }
  </script>



</body>
</html>
