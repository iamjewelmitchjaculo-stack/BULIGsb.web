<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign Up - Bulig Sta. Barbara</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/theme.css" />
</head>

<body>



  <section class="py-5">
    <div class="rounded-card">

      <h3 class="text-center fw-bold">Sign up</h3>
      <p class="text-center mb-4">Join our community of generous donors</p>

      <form id="signupForm" method="post" action="#">

        <label class="fw-semibold">Name</label>
        <input name="name" class="form-control mb-3" required placeholder="Enter your full name" />

        <label class="fw-semibold">Email</label>
        <input name="email" class="form-control mb-3" required placeholder="Enter your email address" type="email" />

        <label class="fw-semibold">Location</label>
        <input name="location" class="form-control mb-3" placeholder="Enter your location" />

        <label class="fw-semibold">Password</label>
        <input name="password" class="form-control mb-4" type="password" required placeholder="Create a password" />

        <button class="btn btn-orange w-100" type="submit">Next →</button>

      </form>
    </div>
  </section>

  <script type="module">
    import { signupUser, loginUser, sendPasswordReset, getUserRole } from './firebase-auth.js';
    import { auth } from './firebase-config.js';
    import { confirmModal } from './modal.js';

    const form = document.getElementById('signupForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = e.target;
      const name = f.name.value;
      const email = f.email.value;
      const password = f.password.value;
      const location = f.location.value;
      try {
        const cred = await signupUser({ name, email, password, location });
        const role = await getUserRole(cred.user.uid);
        window.location.href = role === 'admin' ? 'admin.html' : 'categories.html';
      } catch (err) {
        // Offer sign-in or password reset when email already exists
        if (err && err.code === 'auth/email-already-in-use') {
          const signIn = await confirmModal('This email is already registered. Sign in with the password you entered?', 'Sign In', 'Send Reset');
          if (signIn) {
            try {
              const cred = await loginUser(email, password);
              const role = await getUserRole(cred.user.uid);
              window.location.href = role === 'admin' ? 'admin.html' : 'categories.html';
            } catch (loginErr) {
              if (loginErr && loginErr.code === 'auth/wrong-password') {
                const sendReset = await confirmModal('Password is incorrect. Send a password reset email?', 'Send Reset', 'Cancel');
                if (sendReset) {
                  await sendPasswordReset(email);
                  alert('Password reset email sent — check your inbox.');
                }
              } else {
                alert(loginErr.message || 'Sign in failed');
              }
            }
          } else {
            try {
              await sendPasswordReset(email);
              alert('Password reset email sent — check your inbox.');
            } catch (resetErr) {
              alert(resetErr.message || 'Failed to send password reset email');
            }
          }
        } else {
          alert(err.message || 'Signup failed');
        }
      }
    });

    // If already signed-in, redirect based on role
    try {
      const user = auth && auth.currentUser;
      if (user) {
        const role = await getUserRole(user.uid);
        window.location.href = role === 'admin' ? 'admin.html' : 'categories.html';
      }
    } catch(e) {}

    // Prefill email from query params (do not prefill password). Remove password param if present.
    const params = new URLSearchParams(window.location.search);
    const qEmail = params.get('email');
    if (qEmail) {
      const emailInput = document.querySelector('input[name=email]');
      if (emailInput) emailInput.value = decodeURIComponent(qEmail);
    }
    if (params.has('password')) {
      params.delete('password');
      const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      history.replaceState({}, document.title, newUrl);
    }
  </script>

  

</body>
</html>
