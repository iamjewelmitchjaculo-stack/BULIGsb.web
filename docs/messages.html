<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Messages - Bulig Sta. Barbara</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/theme.css" />

  <style>
    body { background: var(--light-peach); }
    .messages-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 48px);
      background: white;
      max-width: 940px;
      margin: 24px auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 28px rgba(20,20,20,0.08);
    }
    .messages-header {
      background: linear-gradient(90deg, var(--dark-orange), var(--primary-orange));
      color: white;
      padding: 1rem 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .messages-header h4 { margin: 0; font-weight: 700; letter-spacing: 0.2px; }
    .messages-header .back-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem; transition: 0.2s; }
    .messages-header .back-btn:hover { background: rgba(255,255,255,0.3); color: white; }
    .messages-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      background: linear-gradient(180deg, #fff 0%, #fffaf6 100%);
    }
    .message {
      display: flex;
      margin-bottom: 1rem;
    }
    .message.user {
      justify-content: flex-end;
    }
    .message.admin {
      justify-content: flex-start;
    }
    .message-bubble {
      max-width: 72%;
      padding: 0.8rem 1rem;
      border-radius: 14px;
      word-wrap: break-word;
      font-size: 0.96rem;
      line-height: 1.3;
      box-shadow: 0 4px 10px rgba(12,12,12,0.03);
    }
    .message.user .message-bubble {
      background: var(--soft-orange);
      color: white;
      border-radius: 15px 0 15px 15px;
    }
    .message.admin .message-bubble {
      background: #f0f0f0;
      color: #333;
      border-radius: 0 15px 15px 15px;
    }
    .message-time {
      font-size: 0.75rem;
      color: #999;
      margin-top: 0.3rem;
    }
    .donation-card-msg {
      background: linear-gradient(90deg,#fff,#fff7f0);
      border-left: 4px solid var(--primary-orange);
      padding: 0.85rem 1rem;
      border-radius: 10px;
      margin: 0.4rem 0;
      font-size: 0.95rem;
    }
    .donation-card-msg strong { color: var(--dark-orange); }
    .donation-card-msg small { color: #666; display: block; margin-top: 0.25rem; }
    .status-badge { display: inline-block; padding: 0.18rem 0.5rem; border-radius: 999px; font-size: 0.78rem; font-weight: 600; }
    .status-badge.pending { background: #fff4e6; color: #8a4b00; border: 1px solid #ffe6c9; }
    .status-badge.dispatched { background: #e8f6ff; color: #055160; border: 1px solid #cfefff; }
    .status-badge.completed { background: #edf7ed; color: #1b5e20; border: 1px solid #cfeccc; }
    .messages-input-area {
      background: #fff;
      border-top: 1px solid #f0e6dd;
      padding: 0.85rem;
      display: flex;
      gap: 0.6rem;
      align-items: center;
    }
    .messages-input-area input {
      flex: 1;
      border-radius: 40px;
      border: 2px solid #e0e0e0;
      padding: 0.6rem 1rem;
      font-size: 0.95rem;
    }
    .messages-input-area input:focus {
      border-color: var(--soft-orange);
      outline: none;
    }
    .messages-input-area button {
      border-radius: 40px;
      padding: 0.6rem 1.2rem;
      font-weight: 600;
    }
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .settings-modal.active { display: flex; }
    .settings-content {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    .settings-content h3 { color: var(--dark-orange); margin-bottom: 1.5rem; }
    .settings-item {
      padding: 0.8rem 0;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .settings-item:last-child { border-bottom: none; }
    .settings-item label { margin: 0; font-weight: 500; }
    .logout-btn {
      background: #d32f2f;
      color: white;
      border: none;
      width: 100%;
      padding: 0.8rem;
      border-radius: 10px;
      margin-top: 1.5rem;
      font-weight: 600;
      cursor: pointer;
    }
    .logout-btn:hover { background: #c62828; }
    @media (max-width: 768px) {
      .messages-container { margin: 12px; border-radius: 8px; }
      .message-bubble { max-width: 86%; }
    }
  </style>
</head>

<body>
  <div class="messages-container">
    <!-- Header -->
    <div class="messages-header">
      <a href="categories.html" class="back-btn">← Back</a>
      <h4 style="display:inline-flex;align-items:center;gap:10px;margin:0;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>Messages & Updates</h4>
      <button id="settingsBtn" class="settings-icon" title="Settings" style="border:none;background:var(--primary-orange);color:white;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:18px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06A2 2 0 014.3 17.9l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82L4.3 6.7A2 2 0 016.13 3.87l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09c.12.7.56 1.27 1.21 1.51h.06a1.65 1.65 0 001.82-.33l.06-.06A2 2 0 0119.7 6.1l-.06.06a1.65 1.65 0 00-.33 1.82V9c.35.39.59.87.7 1.41h.09a2 2 0 010 4h-.09c-.11.54-.35 1.02-.7 1.41v.08z" stroke="currentColor" stroke-width="0.6"/></svg>
      </button>
    </div>

    <!-- Chat Area -->
    <div class="messages-content" id="messagesContent">
      <div class="text-center text-muted">
        <p>Loading messages...</p>
      </div>
    </div>

    <!-- Input Area -->
    <div class="messages-input-area">
      <input type="text" id="messageInput" placeholder="Type your message..." />
      <button id="sendBtn" class="btn btn-orange">Send</button>
    </div>
  </div>

  <!-- Settings Modal (Profile + Logout) -->
  <div id="settingsModal" class="settings-modal">
    <div class="settings-content">
      <h3>Settings</h3>
      <div style="display:flex;flex-direction:column;gap:0.6rem;">
        <button id="profileBtn" class="btn btn-light">Profile</button>
        <button id="logoutBtn" class="logout-btn">Logout</button>
        <button id="closeSettingsBtn" class="btn btn-light w-100 mt-2">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { logoutUser, onAuthChange } from './firebase-auth.js';
    import { collection, query, where, orderBy, limit, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const messagesContent = document.getElementById('messagesContent');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileBtn = document.getElementById('profileBtn');

    let currentUser = null;

    // Auth listener
    onAuthChange(user => {
      currentUser = user;
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      loadMessages();
    });

    // Settings modal handlers
    settingsBtn.addEventListener('click', () => {
      settingsModal.classList.add('active');
    });
    closeSettingsBtn.addEventListener('click', () => {
      settingsModal.classList.remove('active');
    });
    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) {
        settingsModal.classList.remove('active');
      }
    });

    // Logout handler
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        try {
          await logoutUser();
          window.location.href = '/';
        } catch (e) {
          alert(e.message || 'Logout failed');
        }
      });
    }

    // Profile navigation
    if (profileBtn) {
      profileBtn.addEventListener('click', () => {
        settingsModal.classList.remove('active');
        window.location.href = 'profile.html';
      });
    }

    // Load messages for the current user
    function loadMessages() {
      if (!currentUser) return;

      const messagesRef = collection(db, 'messages');
      const q = query(
        messagesRef,
        where('userId', '==', currentUser.uid),
        orderBy('createdAt', 'asc'),
        limit(100)
      );

      onSnapshot(q, (snapshot) => {
        messagesContent.innerHTML = '';

        if (snapshot.empty) {
          messagesContent.innerHTML = `
            <div class="text-center text-muted">
              <p>No messages yet. Your donation confirmations and updates will appear here.</p>
            </div>
          `;
          return;
        }

        snapshot.forEach((doc) => {
          const msg = doc.data();
          const isUser = msg.senderRole === 'user';
          const time = msg.createdAt?.toDate().toLocaleString() || '';

          // Build content blocks
          let contentNode = document.createElement('div');

          if (msg.type === 'donation_confirmation' || msg.type === 'status_update') {
            // Donation/status card
            const title = document.createElement('div');
            title.innerHTML = `<strong>Donation #${String(msg.donationId || '').slice(0,8)}</strong>`;

            const card = document.createElement('div');
            card.className = 'donation-card-msg';
            card.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div><strong>${msg.type === 'donation_confirmation' ? '✓ Received' : 'Update'}</strong></div>
                <div><span class="status-badge ${msg.status || 'pending'}">${(msg.status || 'pending').toUpperCase()}</span></div>
              </div>
              <small><strong>Category:</strong> ${msg.category || '—'}</small>
              <small><strong>Items:</strong> ${msg.items || '—'}</small>
            `;

            contentNode.appendChild(title);
            contentNode.appendChild(card);
            
            // Add the full message text if it exists
            if (msg.message) {
              const msgText = document.createElement('div');
              msgText.style.marginTop = '0.75rem';
              msgText.style.padding = '0.75rem';
              msgText.style.background = '#f5f5f5';
              msgText.style.borderRadius = '8px';
              msgText.style.fontSize = '0.95rem';
              msgText.style.lineHeight = '1.4';
              msgText.textContent = msg.message;
              contentNode.appendChild(msgText);
            }
          } else {
            // Plain text / user message
            const p = document.createElement('div');
            p.textContent = msg.message || '';
            contentNode.appendChild(p);
          }

          const bubbleDiv = document.createElement('div');
          bubbleDiv.className = `message ${isUser ? 'user' : 'admin'}`;
          const inner = document.createElement('div');
          inner.appendChild(contentNode);
          const timeDiv = document.createElement('div');
          timeDiv.className = 'message-time';
          timeDiv.textContent = time;
          inner.appendChild(timeDiv);

          const bubble = document.createElement('div');
          bubble.className = 'message-bubble';
          bubble.appendChild(inner);

          bubbleDiv.appendChild(bubble);
          messagesContent.appendChild(bubbleDiv);
        });

        // Scroll to bottom
        messagesContent.scrollTop = messagesContent.scrollHeight;
      });
    }

    // Send message handler
    sendBtn.addEventListener('click', async () => {
      const text = messageInput.value.trim();
      if (!text || !currentUser) return;

      try {
        await addDoc(collection(db, 'messages'), {
          userId: currentUser.uid,
          senderRole: 'user',
          message: text,
          type: 'user_message',
          createdAt: serverTimestamp()
        });
        messageInput.value = '';
      } catch (err) {
        alert('Failed to send message: ' + (err.message || ''));
      }
    });

    // Allow sending with Enter key
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });
  </script>
</body>
</html>
