<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Bulig Sta. Barbara</title>

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/theme.css" />

  <style>
    .admin-nav-tabs { border-bottom: 2px solid #e0e0e0; }
    .nav-link { color: #666; font-weight: 600; border: none; border-bottom: 3px solid transparent; }
    .nav-link.active { color: var(--dark-orange); border-bottom-color: var(--dark-orange); background: none; }
    .nav-link:hover { color: var(--dark-orange); }
    
    .messaging-container {
      display: flex;
      flex-direction: column;
      height: 600px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .message-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    
    .message-item {
      padding: 0.8rem;
      background: #f5f5f5;
      border-radius: 8px;
      border-left: 4px solid var(--primary-orange);
    }
    
    .message-item.admin {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    
    .message-item strong { color: var(--dark-orange); display: block; margin-bottom: 0.3rem; }
    .message-item small { color: #666; }
    .message-item p { margin: 0.5rem 0 0 0; color: #333; }
    
    .donor-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    
    .donor-item {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      transition: 0.2s;
    }
    
    .donor-item:hover { background: #fafafa; }
    .donor-item.active { background: #fff3e0; border-left: 4px solid var(--primary-orange); }
    
    .message-input-area {
      border-top: 1px solid #e0e0e0;
      padding: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    
    .message-input-area textarea {
      flex: 1;
      resize: none;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      padding: 0.6rem;
      font-family: 'Segoe UI', sans-serif;
      font-size: 0.9rem;
    }
    
    .message-input-area textarea:focus {
      border-color: var(--soft-orange);
      outline: none;
    }
    
    .message-input-area button { padding: 0.6rem 1.2rem; }
  </style>
</head>

<body>

  <!-- HEADER -->
  <nav class="navbar navbar-dark" style="background: var(--dark-orange);">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold">Admin Dashboard</span>
      <!-- Settings (button opens modal) -->
      <button id="settingsBtn" class="btn" style="border-radius:50%;width:50px;height:50px;padding:0;background:var(--primary-orange);color:white;display:flex;align-items:center;justify-content:center;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06A2 2 0 014.3 17.9l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09a1.65 1.65 0 001.51-1 1.65 1.65 0 00-.33-1.82L4.3 6.7A2 2 0 016.13 3.87l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09c.12.7.56 1.27 1.21 1.51h.06a1.65 1.65 0 001.82-.33l.06-.06A2 2 0 0119.7 6.1l-.06.06a1.65 1.65 0 00-.33 1.82V9c.35.39.59.87.7 1.41h.09a2 2 0 010 4h-.09c-.11.54-.35 1.02-.7 1.41v.08z" stroke="currentColor" stroke-width="0.6"/></svg>
      </button>
      <!-- Settings modal -->
      <div id="settingsModal" class="settings-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:1500;">
        <div class="settings-content" style="background:white;border-radius:12px;padding:1.25rem;max-width:360px;width:90%;box-shadow:0 8px 24px rgba(0,0,0,0.12);">
          <h5 style="color:var(--dark-orange);margin:0 0 0.75rem 0;">Settings</h5>
          <div style="display:flex;flex-direction:column;gap:0.5rem;">
            <button id="profileBtn" class="btn btn-light">Profile</button>
            <button id="logoutBtn" class="btn btn-danger">Logout</button>
            <button id="closeSettingsBtn" class="btn btn-outline-secondary">Close</button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container py-4">

    <!-- Tabs -->
    <ul class="nav admin-nav-tabs mb-4">
      <li class="nav-item">
        <a class="nav-link active" id="donationsTab" href="#" data-tab="donations"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" style="vertical-align:middle;margin-right:6px"><path d="M3 13h4v8H3zM10 3h4v18h-4zM17 8h4v13h-4z" fill="currentColor"/></svg>Donations</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="messagesTab" href="#" data-tab="messages"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" style="vertical-align:middle;margin-right:6px"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>Messages</a>
      </li>
    </ul>

    <!-- Donations Tab -->
    <div id="donationsPanel" class="tab-panel active">
      <h3 class="fw-bold text-center mb-4">Donation Monitoring</h3>

      <div class="table-responsive">
        <table class="table table-bordered table-striped text-center">
          <thead class="table-dark">
            <tr>
              <th>Category</th>
              <th>Amount / Items</th>
              <th>Donor</th>
              <th>Date</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="donationsTable">
            <!-- Real-time data appears here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Messages Tab -->
    <div id="messagesPanel" class="tab-panel" style="display: none;">
      <h3 class="fw-bold text-center mb-4">Donor Communications</h3>

      <div class="row">
        <!-- Donors List -->
        <div class="col-md-4">
          <h5 class="fw-bold mb-3">Donors</h5>
          <div class="donor-list" id="donorsList">
            <p class="text-muted p-3">Loading donors...</p>
          </div>
        </div>

        <!-- Messaging Area -->
        <div class="col-md-8">
          <h5 class="fw-bold mb-3">Conversation</h5>
          <div class="messaging-container">
            <div class="message-list" id="messageList">
              <p class="text-muted text-center">Select a donor to view messages</p>
            </div>
            <div class="message-input-area">
              <textarea id="messageInput" placeholder="Type your update..." rows="2"></textarea>
              <button id="sendMessageBtn" class="btn btn-orange" style="height: 60px;">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>


  <!-- SCRIPTS -->
  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { logoutUser, getUserRole } from './firebase-auth.js';
    import {
  collection,
  query,
  onSnapshot,
  addDoc,
  where,
  orderBy,
  serverTimestamp,
  getDocs,
  getDoc,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

import {
  getFunctions,
  httpsCallable
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";

    // Auth & role check
    let currentAdminUid = null;
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      const role = await getUserRole(user.uid);
      if (role !== 'admin') {
        alert('Access denied. Admin only.');
        window.location.href = '/';
        return;
      }
      currentAdminUid = user.uid;
      loadDonations();
      loadDonors();
    });

    // Settings modal handlers (Profile + Logout)
    const settingsBtnEl = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const profileBtn = document.getElementById('profileBtn');
    const logoutBtnEl = document.getElementById('logoutBtn');

    if (settingsBtnEl) {
      settingsBtnEl.addEventListener('click', () => { settingsModal.style.display = 'flex'; });
    }
    if (closeSettingsBtn) {
      closeSettingsBtn.addEventListener('click', () => { settingsModal.style.display = 'none'; });
    }
    if (settingsModal) {
      settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) settingsModal.style.display = 'none'; });
    }
    if (profileBtn) {
      profileBtn.addEventListener('click', () => { settingsModal.style.display = 'none'; window.location.href = 'profile.html'; });
    }
    if (logoutBtnEl) {
      logoutBtnEl.addEventListener('click', async () => {
        try {
          await logoutUser();
          window.location.href = 'login.html';
        } catch (err) {
          alert('Logout failed: ' + (err.message || err));
        }
      });
    }

    // Tab switching
    document.querySelectorAll('[data-tab]').forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const tabName = e.target.dataset.tab;
        
        document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
        
        if (tabName === 'donations') {
          document.getElementById('donationsPanel').style.display = 'block';
          e.target.classList.add('active');
        } else if (tabName === 'messages') {
          document.getElementById('messagesPanel').style.display = 'block';
          e.target.classList.add('active');
        }
      });
    });

    // Load donations (with debug logging and fallback)
    async function loadDonations() {
      console.debug('loadDonations: db=', db);
      if (!db) {
        console.error('Firestore `db` is undefined. Aborting loadDonations.');
        const tbody = document.getElementById('donationsTable');
        tbody.innerHTML = '<tr><td colspan="5">Firestore not initialized (db is undefined)</td></tr>';
        return;
      }
      const donationsRef = collection(db, 'donations');
      const q = query(donationsRef, orderBy('createdAt', 'desc'));

      // Quick one-time read to help debug security / connectivity issues
      try {
        const oneShot = await getDocs(donationsRef);
        console.debug('getDocs(donations) returned', oneShot.size, 'docs');
        oneShot.forEach(d => console.debug('doc', d.id, d.data()));
      } catch (err) {
        console.error('getDocs(donations) error:', err);
      }

      // Real-time listener with error callback to surface rule/index errors
      onSnapshot(q, (snapshot) => {
        const tbody = document.getElementById('donationsTable');
        tbody.innerHTML = '';

        snapshot.forEach((doc) => {
          const d = doc.data();
          const dateStr = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : "—";
          const items = Array.isArray(d.items)
                      ? d.items.map(i => `${i.qty || ''} ${i.unit || ''} ${i.name || ''}`).join(', ')
                      : "—";
          const row = document.createElement('tr');
          // Prepare safe strings for data attributes
          const dataDonorName = (d.donorName || 'Donor').replace(/"/g, '&quot;');
          const dataCategory = (d.category || '').replace(/"/g, '&quot;');
          const dataItems = (items || '').replace(/"/g, '&quot;');

          row.innerHTML = `
            <td>${d.category}</td>
            <td>${items}</td>
            <td>${d.donorName || 'Anonymous'}</td>
            <td>${dateStr}</td>
            <td>
              <select class="form-select form-select-sm status-select" data-id="${doc.id}" data-userid="${d.userId || ''}" data-donorname="${dataDonorName}" data-category="${dataCategory}" data-items="${dataItems}" data-current="${d.status || 'pending'}">
                <option value="pending" ${(d.status || 'pending') === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="dispatched" ${d.status === 'dispatched' ? 'selected' : ''}>Dispatched</option>
                <option value="completed" ${d.status === 'completed' ? 'selected' : ''}>Completed</option>
              </select>
            </td>
            <td>
                <button class="btn btn-sm btn-success verify-btn" data-id="${doc.id}">Message</button>
            </td>
          `;
          tbody.appendChild(row);
        });

        // Attach status change handlers
        document.querySelectorAll('.status-select').forEach(sel => {
          sel.addEventListener('change', async (e) => {
            const donationId = e.target.dataset.id;
            const newStatus = e.target.value;
            const donationUserId = e.target.dataset.userid;
            const donorName = e.target.dataset.donorname || 'there';
            const donationCategory = e.target.dataset.category || '';
            const donationItems = e.target.dataset.items || '';

            try {
              await updateDoc(doc(db, 'donations', donationId), { 
                status: newStatus,
                updatedAt: serverTimestamp()
              });
              console.log('Status updated to:', newStatus);

              // Send a status update message to the donor (if we have their uid)
              if (donationUserId) {
                const idShort = String(donationId).slice(0,8);
                let statusText = '';

                if (newStatus === 'dispatched') {
                  statusText = `Hi ${donorName}, your donation (#${idShort}) of ${donationItems || 'items'} (${donationCategory || 'category'}) has been dispatched for pickup/delivery. We'll notify you when it's completed. Thank you for your generosity!`;
                } else if (newStatus === 'completed') {
                  statusText = `Hi ${donorName}, thank you! Your donation (#${idShort}) of ${donationItems || 'items'} (${donationCategory || 'category'}) has been received and marked as completed. We appreciate your support.`;
                } else {
                  statusText = `Hi ${donorName}, the status of your donation (#${idShort}) is now: ${newStatus}. We'll keep you posted.`;
                }

                await addDoc(collection(db, 'messages'), {
                  userId: donationUserId,
                  senderRole: 'admin',
                  type: 'status_update',
                  donationId: donationId,
                  category: donationCategory,
                  items: donationItems,
                  message: statusText,
                  status: newStatus,
                  createdAt: serverTimestamp()
                });
                console.log('Status message sent to user:', donationUserId);
              }

            } catch (err) {
              console.error('status update error', err);
              alert('Error updating status: ' + (err.message || err));
            }
          });
        });

        // Attach message/verify handlers
        document.querySelectorAll('.verify-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const donationId = e.target.dataset.id;
            // Find the donor info from the row
            const row = e.target.closest('tr');
            const donorName = row.querySelector('td:nth-child(3)').textContent;
            const donorId = null; // We'd need to store this; for now, focus on status update
            alert('Message feature: Send status update to donor "' + donorName + '" about donation ' + donationId + '.\n\nUse the Messages tab to communicate.');
          });
        });
      }, (err) => {
        console.error('onSnapshot(donations) error:', err);
        const tbody = document.getElementById('donationsTable');
        tbody.innerHTML = `<tr><td colspan="5">Error loading donations: ${err.message || err}</td></tr>`;
      });
    }

    // Load donors with messages
    let selectedDonorUid = null;
    let selectedDonorName = null;

    function loadDonors() {
      console.debug('loadDonors: db=', db);
      if (!db) {
        console.error('Firestore `db` is undefined. Aborting loadDonors.');
        const donorsList = document.getElementById('donorsList');
        donorsList.innerHTML = '<p class="text-muted p-3">Firestore not initialized (db is undefined)</p>';
        return;
      }
      
      // Get unique donors from donations collection (which has donor names)
      const donationsRef = collection(db, 'donations');
      const q = query(donationsRef);

      onSnapshot(q, async (snapshot) => {
        const donorsMap = {}; // Map of userId -> donorName

        snapshot.forEach((doc) => {
          const donation = doc.data();
          if (donation.userId && donation.donorName) {
            donorsMap[donation.userId] = donation.donorName;
          }
        });

        console.debug('Found donors from donations:', donorsMap);

        // Render donors list
        const donorsList = document.getElementById('donorsList');
        donorsList.innerHTML = '';

        if (Object.keys(donorsMap).length === 0) {
          donorsList.innerHTML = '<p class="text-muted p-3">No donors yet</p>';
          return;
        }

        // Sort donor IDs for consistent display
        const sortedDonorIds = Object.keys(donorsMap).sort();
        
        sortedDonorIds.forEach((uid) => {
          const item = document.createElement('div');
          item.className = 'donor-item';
          item.textContent = donorsMap[uid];
          item.addEventListener('click', () => {
            selectedDonorUid = uid;
            selectedDonorName = donorsMap[uid];
            document.querySelectorAll('.donor-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            loadDonorMessages(uid);
          });
          donorsList.appendChild(item);
        });
      });
    }

    // Load messages for selected donor
    function loadDonorMessages(donorUid) {
      const messagesRef = collection(db, 'messages');
      const q = query(messagesRef, where('userId', '==', donorUid), orderBy('createdAt', 'asc'));

      onSnapshot(q, (snapshot) => {
        const messageList = document.getElementById('messageList');
        messageList.innerHTML = '';

        if (snapshot.empty) {
          messageList.innerHTML = '<p class="text-muted text-center">No messages</p>';
          return;
        }

        snapshot.forEach((doc) => {
          const msg = doc.data();
          let time = '';
          if (msg.createdAt) {
            if (typeof msg.createdAt.toDate === 'function') {
              time = msg.createdAt.toDate().toLocaleTimeString();
            } else if (msg.createdAt instanceof Date) {
              time = msg.createdAt.toLocaleTimeString();
            }
          }
          const isAdmin = msg.senderRole === 'admin';

          const msgDiv = document.createElement('div');
          msgDiv.className = `message-item ${isAdmin ? 'admin' : ''}`;
          msgDiv.innerHTML = `
            <strong>${isAdmin ? '✓ You' : selectedDonorName}</strong>
            <small>${time}</small>
            <p>${msg.message}</p>
          `;
          messageList.appendChild(msgDiv);
        });

        messageList.scrollTop = messageList.scrollHeight;
      });
    }

    // Send message handler
    document.getElementById('sendMessageBtn').addEventListener('click', async () => {
      if (!selectedDonorUid) {
        alert('Select a donor first');
        return;
      }

      const text = document.getElementById('messageInput').value.trim();
      if (!text) return;

      try {
        await addDoc(collection(db, 'messages'), {
          userId: selectedDonorUid,
          senderRole: 'admin',
          type: 'status_update',
          message: text,
          createdAt: serverTimestamp()
        });
        document.getElementById('messageInput').value = '';
      } catch (err) {
        alert('Failed to send message: ' + err.message);
      }
    });

    // Allow Enter to send
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        document.getElementById('sendMessageBtn').click();
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

